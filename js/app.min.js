var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Settings=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"setItem",value:function(e,t){return this._shouldUseLocalStorage?localStorage.setItem(e,t):$.cookie(e,t,{expires:30})}},{key:"getItem",value:function(e){return this._shouldUseLocalStorage?localStorage.getItem(e):$.cookie(e)||null}},{key:"remove",value:function(e){return this._shouldUseLocalStorage?localStorage.removeItem(e):$.cookie(e,"",{expires:-1})}},{key:"is",value:function(e){return"true"===this.getItem(e)}},{key:"prop",value:function(e,t){return void 0!==t?null===t?this.remove(e):this.setItem(e,t):this.getItem(e)}},{key:"_shouldUseLocalStorage",get:function(){if(!this.__shouldUseLocalStorage__)try{window.localStorage.setItem("storage-test","1"),window.localStorage.removeItem("storage-test"),this.__shouldUseLocalStorage__=!0}catch(e){this.__shouldUseLocalStorage__=!1}return this.__shouldUseLocalStorage__}}]),e}(),DRRR={messageLimit:300,messageLimitMobile:150,hasLocalStorage:Settings._shouldUseLocalStorage,isMod:!1,getRoomsRunning:!1},calcDateSince=function(e){var t="";if("0"!==e){var n=Math.abs((new Date).getTime()-1e3*e),i=Math.floor(n/864e5);n-=864e5*i;var o=Math.floor(n/36e5);n-=36e5*o;var a=Math.floor(n/6e4);n-=6e4*a;var s=Math.floor(n/1e3);n-=1e3*s,t=i?i+"d, "+o+"h, "+a+"m, "+s+"s":o?o+"h, "+a+"m, "+s+"s":a?a+"m, "+s+"s":s+"s"}else t="N/A";return t};function escapeHtml(e){var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};return String(e).replace(/[&<>"'`=\/]/g,function(e){return t[e]})}function html(e){for(var t=e.raw,n="",i=arguments.length,o=Array(i>1?i-1:0),a=1;a<i;a++)o[a-1]=arguments[a];return o.forEach(function(e,i){var o=t[i];Array.isArray(e)&&(e=e.join("")),o.endsWith("$")&&(e=escapeHtml(e),o=o.slice(0,-1)),n+=o,n+=e}),n+=t[t.length-1]}$(function(){"use strict";var e,n,i=$("#profile .lang").text(),o=$("#profile .lang-friends").text().split(" "),a=$("#toggle-adult-rooms");function s(){"box"in window&&"clearSession"in box&&box.clearSession();var a=$(".rooms-wrap"),s=$("#rooms-count"),r=$("#rooms-hidden-count"),l=$("#rooms-adult-count"),c=$("#online-count"),u=$(".load-placeholder--lounge"),d=location.baseURL+"/lounge?api=json";DRRR.getRoomsRunning||(u.addClass("on animate"),DRRR.getRoomsRunning=!0,$.getJSON(d).done(function(d){var m,p=[],f=0,h=0,g=0;if("rooms"in d){f=(m=d.rooms).length,d.profile.admin&&(DRRR.isMod=!0,document.body.classList.add("is-mod"));for(var v=0;v<f;v++){var w=[],b=m[v];if(void 0!==(H=b.description)&&""!==(""+H).trim()&&w.push("data-description"),b.music&&w.push("data-music"),b.staticRoom&&w.push("data-pinned"),b.gameRoom&&w.push("data-game"),b.hiddenRoom&&(w.push("data-hidden"),h++),!b.adultRoom||(w.push("data-adult"),g++,e)){var y=!1,k="",R=b.total/b.limit;R>=1&&(w.push("data-full"),y=!0),y&&!DRRR.isMod&&(k=" disabled");var x="";b.language&&(x=b.language.replace(/^[a-zA-Z]+?-/i,""));var S=calcDateSince(b.since),C="blank",_="N/A";b.host&&(C=b.host.icon,_=b.host.name);var M="";DRRR.isMod&&(M='\n            <input type="submit"\n              name="staticize"\n              value="'+!b.staticRoom+'"\n              class="admin-room-pin '+(b.staticRoom?"pinned":"unpinned")+'"\n            >\n            <input type="submit"\n              name="conceal"\n              value="'+!b.hiddenRoom+'"\n              class="admin-room-pin '+(b.hiddenRoom?"pinned":"unpinned")+'"\n            >\n            <input type="submit"\n              name="adult"\n              value="'+!b.adultRoom+'"\n              class="admin-room-pin '+(b.adultRoom?"pinned":"unpinned")+'"\n            >\n            <input type="hidden" name="id" value="'+b.id+'">\n          ');for(var T=[],B=[],D=[],N=b.users,L=N.length,P=0;P<L;P++){var I=N[P],O=I.name,A="",U="";I.tripcode&&(A="#"+I.tripcode,U="<span class=tripcode>#"+I.tripcode+"</span>");var j="";switch(I.device){case"bot":j="bot";break;case"tv":j="tv";break;case"tablet":j="tablet";break;case"mobile":j="phone";break;default:j="desktop"}var E=" <span class='icon icon-device-type icon-"+j+"'></span>";T.push("\n            <div class='avatar-wrap'>\n              <span class='symbol symbol-"+I.icon+"'></span>\n              "+escapeHtml(escapeHtml(O))+(U+E)+"\n            </div>\n          "),B.push(escapeHtml(O)+A),D.push('\n            <div class="avatar-wrap symbol-wrap-'+I.icon+'">\n              <span class="symbol symbol-'+I.icon+'"></span>\n              '+escapeHtml(O)+(U+E)+"\n            </div>\n          ")}p.push('\n          <ul class="rooms"\n            lang="'+b.language+'"\n            data-meta="'+escapeHtml(b.name)+" "+B.join(" ")+'"\n            '+w.join(" ")+'\n          >\n            <li class="name">\n              <form action="/room/" method="get">\n                <button class="btn btn-link select-text lounge-room-name" type="submit" name="id" value="'+b.id+'" '+k+">\n                  "+M+'\n                  <span class="room-badge room-badge-music"><i class="icon icon-music"></i></span>\n                  <span class="room-badge room-badge-description"><i class="icon icon-note"></i></span>\n                  <span class="room-name" title="'+escapeHtml(b.name)+'">'+escapeHtml(b.name)+'</span>\n                </button>\n              </form>\n            </li>\n\n            <li class="creator">\n              <span class="symbol symbol-'+C+'"></span>\n              '+escapeHtml(_)+'\n            </li>\n\n            <li class="status">\n              <div class="progress-bar-label-wrap">\n                <div class="progress-bar-label room-tooltip"\n                  title="\n                    <div class=\'meta-wrap\'>'+escapeHtml(escapeHtml(b.name))+"</div>\n                    <div class='meta-wrap'>\n                      <i class='region region-"+x+"'></i>\n                      "+b.language+"\n                    </div>\n                    <div class='meta-wrap opacity-05'>"+S+"</div>\n                    <div class='meta-wrap opacity-05'>"+escapeHtml(escapeHtml(b.description))+"</div>\n                    <hr>\n                    "+T.join("")+'\n                ">\n                  '+b.total+" / "+b.limit+'\n                </div>\n              </div>\n              <div class="progress progress-desktop loaded" style="width: '+b.limit/20*100+'%;">\n                <div class="progress-bar '+(y?"progress-bar-danger":"")+'" role="progressbar" style="width: '+100*R+'%;"></div>\n              </div>\n            </li>\n\n            <li class="members">\n              '+D.join("")+"\n            </li>\n          </ul>\n          "),w=[]}else w=[]}var H;a.empty(),a.removeClass("text-center").addClass("rooms-not-loaded"),a.html(p.join("")),function(){var e=[],t=[],n=$(".rooms"),a=$(".rooms-wrap");$(n).each(function(){var n=$(this).attr("lang");i==n?e.unshift(this):o.indexOf(n)>-1&&t.unshift(this)}),0!==t.length&&t.length!=n.length&&$("<hr class=room-splitter>").prependTo(a);for(var s in t)$(t[s]).prependTo(a);0!==e.length&&e.length!=n.length&&$("<hr class=room-splitter>").prependTo(a);for(var r in e)$(e[r]).prependTo(a);$(".rooms-not-loaded").removeClass("rooms-not-loaded")}(),c.text(d.active_user),s.text(f-h),r.text(h),l.text(g),$(".lounge-counter").addClass("on"),function(){if(n)return void n.update();n=new Jets({manualContentHandling:function(e){return e.getAttribute("data-meta")||""},didSearch:function(e){window.location.hash="#"+encodeURIComponent(e)},searchTag:"#rooms-filter",contentTag:"#rooms-filter-support"})}(),$(".room-tooltip").tooltipster({speed:200,delay:0,interactive:!0,onlyOne:!0,position:"top",theme:"tooltipster-drrr",contentAsHTML:!0}),setTimeout(function(){u.removeClass("on slow",setTimeout(function(){u.removeClass("animate")},400))},600)}else swal({title:t("Logged Out"),text:t("Session time out."),type:"warning",showCancelButton:!1,confirmButtonText:t("Reload")},function(e){e&&location.reload(!0)})}).fail(function(){u.addClass("slow")}).always(function(){DRRR.getRoomsRunning=!1}))}function r(){var e=document.getElementById("sidebar-hitokoto"),t=document.getElementById("sidebar-hitokoto-mobile");null!==e&&null!==t&&$.ajax({url:"//hitoapi.cc/s/",dataType:"json",timeout:5e3,success:function(n){n.hasOwnProperty("source")&&(e.title=n.source,e.innerHTML=n.text,t.title=n.source,t.innerHTML=n.text)},error:function(e){}})}(function(){var e,t=document.getElementById("sidebar-bangumi"),n=document.getElementById("sidebar-bangumi-mobile"),o=[];function a(){var t,n=function(e){var t=-540-e.getTimezoneOffset();return new Date(e.getTime()-60*t*1e3)}(new Date),i=n.getMonth()+1;t=i>=1&&i<4?1:i>=4&&i<7?4:i>=7&&i<10?7:10,e={year:n.getFullYear(),month:n.getMonth()+1,bangumiMonth:t,day:n.getDate(),week:n.getDay()}}function s(){$.ajax({url:"//drrr.com/bangumi/"+e.year+"/"+e.bangumiMonth+"/"+e.week,dataType:"json",timeout:5e3,success:function(e){!function(e){for(var t=e.length,n=0;n<t;n++){e[n].name;"zh-CN"===i||"zh-TW"===i?o.push('<li title="'+e[n].namejp+'">'+e[n].name+"</li>"):o.push("<li>"+e[n].namejp+"</li>")}r(o),o=[]}(e)},error:function(e){}})}function r(i){t.innerHTML=i.join(""),n.innerHTML=i.join(""),Settings.prop("bangumidate",e.month+"-"+e.day+"-"+e.year),Settings.prop("bangumicontent",JSON.stringify(i))}})(),$(".rss-update"),$(".load-placeholder--blog"),$(".error-message");var l,c,u,d,m,p,f={calcZero:function(e){return e<10?"0"+e:e},getDate:function(e){return{year:this.calcZero(e.getFullYear()),month:this.calcZero(e.getMonth()+1),day:this.calcZero(e.getDate()),hour:this.calcZero(e.getHours()),minute:this.calcZero(e.getMinutes())}},start:function(){var e=new Date,t=e.getTimezoneOffset(),n=[],i={Local:t/-60,UTC:0,NRT:9,PVG:8,JFK:-5,LAX:-8};for(var o in i){var a=60*i[o]+t,s=new Date(e.getTime()+60*a*1e3),r=this.getDate(s);n.push('\n          <li title="'+[r.month,r.day,r.year].join("-")+'">'+o+" "+r.hour+":"+r.minute+"</li>\n        ")}var l=document.getElementById("timezones");l&&(l.innerHTML=n.join(""))}};location.conformTo("/lounge")&&(p=document.getElementById("profile").getAttribute("data-avatar"),document.body.classList.add("scheme-"+p),e=Settings.is("showadultrooms"),a[0].checked=e,a.on("click",function(){Settings.is("showadultrooms")?(a[0].checked=!1,Settings.prop("showadultrooms",!1),e=!1,$("ul.rooms[data-adult]").remove()):(a[0].checked=!0,Settings.prop("showadultrooms",!0),e=!0,s())}),s(),d=!1,m=function(){d=!0,s(),f.start()},u=setInterval(m,6e4),$(window).focus(function(){clearInterval(u),d||(m(),u=setInterval(m,6e4))}).blur(function(){clearInterval(u),d=!1}),$("#lounge-refresh").click(function(e){s(),r(),f.start()}),l=$("#rooms-filter"),c="",window.location.hash&&(c=window.location.hash.replace(/^#/,""),l.val(decodeURIComponent(c))),r(),f.start(),$(".mobile-clone").clone().appendTo("#sidebar-mobile"))}),location.conformTo("/room")&&$(function(){var e=null,n=null,i=null,o=null,a=null,s=null,r=null,l=null,c=null,u=null,d=null,m=null,p=null,f=null,h=null,g=null,v=null,w=null,b=null,y=null,k=null,R=null,x=null,S=null,C=null,_=null,M=null,T=null,B=null,D=null,N=null,L=null,P=null,I=null,O=null,A=null,U=null,j=null,E=null,H=null,F=null,z=0,J=!0,W=!0,V=!1,G=!1,q=!1,Y=!1,Z=!1,K=!1,X=!1,Q=!1,ee=!1,te=0,ne=null,ie=null,oe=null,ae=null,se=null,re=!1,le=null,ce=null,ue=null,de=null,me=null,pe=null,fe=[],he=[],ge=["iirose.com","grabify.link"];(bowser.ios||bowser.android||bowser.blackberry||bowser.firefoxos)&&(DRRR.isMobile=!0,document.body.classList.add("device-mobile"));var ve=function(){x.show(),we()},we=function(){q&&"abort"in le&&(le.abort(),q=!1,setTimeout(Ye,1e3))},be=function(){x.hide()},ye=function(){new Date},$e=function(e){var t="http://embed.pixiv.net/embed_mk2.php?id=58706284&size=large&border=off&done=null";this.src===t?(this.src=$(this).data("src")+"?a",$(this).unbind(e)):-1!==this.src.indexOf("pixiv.net")?this.src=t:(-1===this.src.indexOf("crossorigin.me/")&&(this.src="//crossorigin.me/"+this.src),$(this).unbind(e))},ke=function(e,t){var n=$("<img />",{src:e,alt:t,"data-src":e,class:"img-thumbnail",click:Se,error:$e}),i=$("<a />",{href:"javascript:;",text:"×",class:"icon btn-delete-image",click:Ce}),o=$("<div />",{class:"image-mask"});o.append(n,i),o=$("<div />",{class:"col-xs-3 col-sm-2 col-lg-1p5"}).append(o),v.append(o)},Re=function(){if(DRRR.hasLocalStorage){var e=localStorage.getItem("dura-imgColl"),t=!1;if(e)try{(e=JSON.parse(e)).forEach(function(e){var t=/[^/]+\.(bmp|jpg|jpeg|png|svg|gif)/i.exec(e)[0];ke(e,t)}),t=!0}catch(e){}t&&b.hide()}},xe=function(){if(DRRR.hasLocalStorage){var e=[];v.find("img").each(function(){e.push($(this).data("src"))}),e.length?localStorage.setItem("dura-imgColl",JSON.stringify(e)):localStorage.removeItem("dura-imgColl")}},Se=function(){var e=$(this).data("src");lt(e),Ot()},Ce=function(){2===v.children().length&&b.show(),$(this).parent().parent().remove()},_e=function(e){var n=$(this).prev(),i=n.data("src");if(!(v.find('[data-src="'+i+'"]').length>0))return ke(i,n.attr("alt")),b.hide(),swal({title:"",text:t("Successfully collected the image!"),type:"success",showConfirmButton:!1,timer:1e3}),!1;swal("",t("You have already collected this image!"),"warning")},Me=function(){void 0===window.expose&&(window.expose={});var e=window.expose;e.toggleMusic=At,e.formChatImageContent=Te,e.writeSelfMessage=gt,e.writeMessageFast=gt,e.clearUnreadMessage=Ne,e.checkPermitionAndShowNotification=Le,e.checkInMessage=at},Te=function(e,t,n,i){var o=$("<a />",{class:"message-link bstooltip",text:i,title:t,href:"javascript:;",click:function(){var e=$(this).next(),t=e.children("img");t.attr("src")||t.attr("src",t.attr("data-src")),e.show(),$(this).hide()}}),a=$("<img />",{"data-src":t,class:"img-thumbnail",alt:n,error:$e}),s=$("<a />",{herf:"javascript:;",class:"icon-heart btn-collect-image",click:_e}),r=$("<div />",{class:"image-mask",click:function(){$(this).prev().show(),$(this).hide()}});Settings.is("autoloadimage")?(a.attr("src",t),o.hide()):r.hide(),r.append(a,s),$(e).append(o,r)},Be=function(e,n,i,o){o=o||!1;var a="@"+n+t(" mentioned you in message:");o&&(a="@"+n+t(" sent you a message:"));var s=null;ee?(macgap.notice.notify({title:a,content:e,sound:!0}),De(),macgap.app.bounce()):"webkitNotifications"in window?((s=webkitNotifications.createNotification(i,a,e)).onclick=function(e){window.focus(),this.close()},s.show()):"Notification"in window&&((s=new Notification(a,{icon:i,title:a,body:e,tag:"mention"})).onclick=function(){window.focus(),this.close()})},De=function(){te+=1,ee&&(macgap.dock.badge=te>DRRR.messageLimit?DRRR.messageLimit+"+":te.toString())},Ne=function(){te=0,ee&&(macgap.dock.badge="")},Le=function(e,t,n,i){J||(fn(location.baseURL+"/favicon-unread.ico"),it(n,function(n){ee?Be(e,t,n,i):"webkitNotifications"in window?webkitNotifications.checkPermission()>0?(webkitNotifications.requestPermission(function(){Be(e,t,n,i)}),navigator.userAgent.match(/Chrome/i)&&$("html").bind("click",function(){webkitNotifications.requestPermission(function(){Be(e,t,n,i)})})):Be(e,t,n,i):"Notification"in window&&("granted"!=Notification.permission?(Notification.requestPermission(function(){Be(e,t,n,i)}),$("html").bind("click",function(){Notification.requestPermission(function(){Be(e,t,n,i)})})):Be(e,t,n,i))}))},Pe=function(){if(X&&0===h.find("input").length){var e=h.text(),n=$("<button />",{class:"btn btn-primary",type:"submit",disabled:"disabled"}).text(t("Change")).click(Yt);h.empty();var i=$("<input />",{placeholder:t("Room name"),class:"form-control form-inline",type:"text",name:"room_limit",size:20,maxlength:20,style:"position: inline-block"}).on("input",function(){$(this).val()!=e?n.removeAttr("disabled"):n.attr("disabled","disabled")}).on("keyup",function(e){27==e.keyCode&&cancelRoomName()});$("<div />",{class:"input-group input-group-sm",id:"room-limit-input"}).append(i).append($("<span />",{class:"input-group-btn"}).append(n).append($("<button />",{class:"btn btn-default ",type:"button"}).text(t("Cancel")).click(function(){window.setTimeout(function(){h.empty(),h.text(e)},0)}))).appendTo(h),i.focus(),i.val(me)}},Ie=function(){o.submit(Ee),a.keypress(kt),l.click(function(){$(this).next().click()}),l.next().change(xt),c.click(St),p.find("li.image").click(Ot),p.find("li.member").click(Ut),p.find("li.setting").click(Ht),g.find("input[name=save]").click(Wt),h.click(Pe),O.click(Vt),U.click(qt),j.click(Lt),H.click(It),E.click(Pt),F.click(Zt),y.find("input[name='play']").click(We),DRRRClientBehavior.bindEvents(s,R),s.on("click",".avatar",bt),s.on("show.bs.dropdown",".dropdown.user",Ae),s.on("hide.bs.dropdown",".dropdown.user",Oe),s.on("dblclick",".dropdown.user .name",yt),R.on("show.bs.dropdown",".dropdown.user",Ae),R.on("hide.bs.dropdown",".dropdown.user",Oe),R.on("dblclick",".dropdown.user .name",yt),S.click(function(e){pn(),e.stopPropagation()}),$(window).on("stop-fetching.kit.drrr",function(){re=!0}),$(window).on("continue-fetching.kit.drrr",function(){re=!1}),$(window).resize(Ft),$(window).unload(xe)},Oe=function(){$(this).find(".dropdown-menu").empty()},Ae=function(){var e=$(this).data(),n=_t(fe,e.id),i=n||e;n&&(i.in_room=!0),i.id==ne&&(i.is_me=!0);var o=$(this).find(".dropdown-menu")[0];$(o).data(i);var a=!1,s=function(){a||($("<li />",{class:"divider",role:"presentation"}).appendTo(o),a=!0)},r=function(){a=!1},l=function(e,t,n){n=n||"dropdown-item";var i=$("<li />").append($("<a />",{tabindex:"-1",class:n,text:e})).appendTo(o);return t&&i.click(t.bind(o)),i};if(i.error)l(t("ERROR"),!1,"dropdown-item-unclickable");else{if(l("@"+i.name,Ct,"dropdown-item-reply"),!i.is_me&&i.in_room&&l(t("DM"),Tt,"dropdown-item-secret"),i.tripcode&&$("<li />").append($("<a />",{tabindex:"-1",class:"dropdown-item-tripcode","data-toggle":"modal","data-target":"#modal-tripcode-help","data-name":i.name,"data-icon":i.icon,text:"#"+i.tripcode})).appendTo(o).children(),K||X){if(i.in_room){if(Y){s();var c=t(i.player?"non-player":"player");if(l(t("Set to {1}",c),Ue),i.hasOwnProperty("alive")){var u=t(i.alive?"dead":"alive");l(t("Set to {1}",u),je)}r()}i.is_host||(s(),l(t("Handover host"),Kt,"dropdown-item-handover"))}else-1!==$(this).parent().attr("class").indexOf("ban")&&l(t("Unban"),an,"dropdown-item-unban");i.id==ne||i.admin||(s(),i.in_room&&l(t("Kick"),sn,"dropdown-item-kick"),l(t("Ban"),nn,"dropdown-item-ban"),X?(l(t("Ban IP"),on,"dropdown-item-ban-ip"),l(t("Try Unban"),an,"dropdown-item-unban"),l(t("Report"),en,"dropdown-item-report-user")):l(t("Report & Ban"),tn,"dropdown-item-report-user"))}r(),i.in_room||(s(),l(t("Not in room"),!1,"dropdown-item-unclickable"))}var d={addNode:l,addDevisionIfNot:s,resetDevider:r};$(window).trigger("room.user.menu.show",[o,i,d]),"userMenuIsShown"in expose&&"function"==typeof expose.userMenuIsShown&&expose.userMenuIsShown(o,i)},Ue=function(){var n=_t(fe,Mt(this).id),i=!n.player;$.ajax({type:"POST",url:e,data:{player:i,to:n.id},timeout:4e3}).done(function(e){be(),ye(),e&&swal(t("Notice"),e,"warning")}).always(function(e){}).fail(function(e){ve(),e&&swal(t("Error"),e,"error")})},je=function(){var n=_t(fe,Mt(this).id),i=!n.alive;$.ajax({type:"POST",url:e,data:{alive:i,to:n.id},timeout:4e3}).done(function(e){be(),ye(),e&&swal(t("Notice"),e,"warning")}).always(function(e){}).fail(function(e){ve(),e&&swal(t("Error"),e,"error")})},Ee=function(){var e=a.val();if(""===e.replace(/\s/g,""))return!1;var n=e.match(/^(\/|／|、)color([\s\S]*)/);if(window.visualizer&&n)return visualizer.changeColor(n[2]),a.val(""),!1;if(V)return!1;var i=o.serialize();return a.val(""),V=!0,u.val(t("Sending...")),pn(),e,e=ze(e),He(e)||gt(e),Je(i,e,0),!1},He=function(e){return Boolean(M.val()||T.val()||Fe(e))},Fe=function(e){return Boolean(/^(\/|／|、)(mc|me|milkcookies|roll|leave|share)([\s\S]*)/.exec(e))},ze=function(e){return e.length-1>_&&(e=e.substring(0,_)+"..."),e.replace(/\s/," "),e},Je=function(n,i,o){if(o>1)return V=!1,u.val(t("POST!")),void a.val(i+t(" (restored) ")+a.val());$.ajax({type:"POST",url:e,data:n,timeout:4e3}).done(function(e){be(),e&&swal(t("Warn"),e,"warning"),V=!1,u.val(t("POST!")),ye(),cn(),ct()}).always(function(){}).fail(function(){ve(),Je(n,i,o+1)})},We=function(){var n=$('input[name="music_name"]').val(),i=$('input[name="music_url"]').val();i?$.ajax({type:"POST",url:e,data:{music:"music",name:n,url:i},timeout:14e3}).done(function(){ye(),window.hasOwnProperty("ga")&&ga("send","event",{eventCategory:"Music",eventAction:"Cast",eventLabel:n})}).always(function(e){e&&swal(t("Music"),e,"warning"),At()}):swal("",t("Sound URL is empty!"),"warning")},Ve={done:function(){return Ve},fail:function(){return Ve}},Ge=function(e,t,i){if(re)return setTimeout(Ze,100),Ve;arguments.callee.caller.name;return function(e,t){if(q||G)return Ve;q=!0;var i={},o=4e3;return e?i.fast=1:o+=1e3*cometTimeout,t&&(i.update=t),le=$.ajax({type:"GET",url:n,data:i,dataType:"json",timeout:o}).done(be).fail(ve).always(function(){q=!1})}(e,t).done(function(e){!0!==i&&setTimeout(Ze,10),e.hasOwnProperty("reload")&&"true"==e.reload?(location.reload(),re=!0):(re=!1,Ke(e))}).fail(function(){"console"in window&&console})},qe=function e(){Ge(!0,0,!0).fail(function(){setTimeout(e,500)})},Ye=function e(){Ge(!0,z).fail(function(){setTimeout(e,1e3)})},Ze=function(){Ge(!1,z).fail(function(){setTimeout(Ye,1e3)})},Ke=function(e){e.hasOwnProperty("error")&&wt(e.error),e.hasOwnProperty("v")&&(e.v>3&&(swal({title:t("Reloading..."),text:t("Version upgraded!"),type:"warning",showConfirmButton:!1}),window.setTimeout(function(){window.location.reload()},2e3)),z!=e.update&&(z=e.update,e.hasOwnProperty("name")&&Xe(e.name),e.hasOwnProperty("description")&&Qe(e.description),e.hasOwnProperty("since")&&et(calcDateSince(e.since)),e.hasOwnProperty("gameRoom")&&(Y=room.gameRoom,i.isGameRoom=room.gameRoom),e.hasOwnProperty("limit")&&tt({limit:e.limit}),e.hasOwnProperty("host")&&zt(e.host),e.hasOwnProperty("djMode")&&Jt(e.djMode),e.hasOwnProperty("users")&&(tt({count:e.users.length}),st(e.users)),e.hasOwnProperty("talks")&&nt(e.talks),e.hasOwnProperty("roomId")&&history.replaceState&&window.history.replaceState({},"","?id="+e.roomId),e.hasOwnProperty("name")&&Gt(e.name),W=!1))},Xe=function(e){ue!=e&&(f.empty(),f.text(e),N.text(e),I.val(e),ue=e)},Qe=function(e){de!=e&&(L.text(e),A.val(e),de=e)},et=function(e){P.text(e)},tt=function(e){e.hasOwnProperty("limit")?e.hasOwnProperty("count")||(e.count=fe.length):e.limit=me,me==e.limit&&e.count==pe||(h.empty(),h.text(e.count+"/"+e.limit),me=e.limit,pe=e.count)},nt=function(e){e.map(ot)},it=function(e,t){if(null!==(e=e.replace(/ .*/,"").trim())&&""!==e)if(e in he)t(he[e]);else{var n="../img/avatar-"+e+".png";n?(he[e]=n,t(n)):t("")}else t("")},ot=function(e){$("#"+e.id).length>0||e.hasOwnProperty("type")&&((e.uid==ne||e.from&&e.from.id==ne||e.user&&e.user.id==ne)&&(e.is_me=!0),e.to&&e.to.id==ne&&(e.to_me=!0),$(window).trigger("room.chat."+e.type,[e]),i.write(e),!W&&!e.is_me&&!e.element.hasClass("hide")&&$(document).scrollTop()>0&&function(){var e=Number(C.text());if(!isNaN(e)){var t=S.find(".singular"),n=S.find(".plurals");e++,C.text(e>DRRR.messageLimit?DRRR.messageLimit+"+":e),e>1?(t.removeClass("on"),n.addClass("on")):(t.addClass("on"),n.removeClass("on")),S.show()}}(),ht())},at=function(e){var t=e+" ";if(ae.test(t)){for(var n in fe){var i=fe[n];if(i.name!=ie&&t.search(i.regex)>-1)return!1}return!0}return!1},st=function(e){fe=[],R.empty(),fe=e.map(function(e){var n=$("<li />",{title:e.name,class:"dropdown user clearfix symbol-wrap-"+e.icon}).append($("<ul />",{class:"dropdown-menu",role:"menu"})).append($("<div />",{class:"name-wrap","data-toggle":"dropdown"}).append($("<span />",{class:"symbol symbol-"+e.icon})).append($("<span />",{class:"select-text name",text:e.name}))).append('<span class="icon-display icon-device"></span> <span class="icon icon-users"></span>');return ce==e.id&&(e.is_host=!0,n.attr("title",e.name+" "+t("(host)")),n.addClass("is-host")),e.admin&&n.addClass("is-mod"),e.device&&n.attr("device",e.device),e.tripcode&&n.addClass("is-tripcode"),e.hasOwnProperty("player")&&n.addClass(e.player?"player":"non-player"),e.hasOwnProperty("alive")&&n.addClass(e.alive?"alive":"dead"),n.data(e),R.append(n),e.regex=new RegExp("@"+escapeForRegExp(e.name)+" "),e}),Ft()},rt=function(){$(d).tooltipster({speed:200,delay:0,interactive:!0,onlyOne:!0,theme:"tooltipster-drrr tooltipster-drrr--light",position:"bottom",trigger:"click",content:$('          <div class="input-group input-group-sm">          <input type="url" class="form-control" id="url-text">          <span class="input-group-btn">          <button class="btn btn-default" type="button" id="url-button-add">+</button>\t\t      <button class="btn btn-default" type="button" id="url-button-del">-</button>          </span>          </div>        '),functionReady:function(e,t){var n=$("#url-text");M.val()&&n.val(M.val());var i=function(){var e=$("#url-text").val();lt(e)};n.keydown(function(e){if(13==e.which)return i(),!1}),$("#url-button-add").on("click",i),$("#url-button-del").on("click",function(){n.val(""),dt()})}})},lt=function(e){var n=$("#url-text");if(vt(e)){var i=/[^/]+\.(bmp|jpg|jpeg|png|svg|gif)/i.exec(e);i?d.text(i[1].toUpperCase()):d.text("URL"),M.val(e),mt(),ft(!0),$(a).focus()}else swal({title:t("Warning"),text:t("It's not a valid URL!"),type:"warning",confirmButtonText:t("OK")},function(e){e&&n.focus()}),dt()},ct=function(){dt(),ut()},ut=function(){T.val(""),pt(!1)},dt=function(){M.val(""),d.text("URL"),ft(!1)},mt=function(){$(d).tooltipster("hide")},pt=function(e){var n=$(o).find(".to-whom");n.removeClass("on").empty(),$(a).removeClass("state-secret"),e&&(n.addClass("on"),n.append(document.createTextNode("@")),n.append(i._formIconNode(e)),n.append(document.createTextNode(e.name+" ")),$("<a />").text("("+t("Cancel")+")").click(ut).appendTo(n),$(a).addClass("state-secret")),a.focus()},ft=function(e){e?$(d).attr("data-status","filled"):$(d).removeAttr("data-status")},ht=function(){$(".talks .talk:first .bstooltip").tooltipster({speed:200,delay:0,interactive:!0,onlyOne:!0,theme:"tooltipster-drrr"})},gt=function(e){var t={type:"message",from:{id:ne},is_fast:!0,is_me:!0,message:e};t.element=i.writeMessage(t,_t(fe,ne)),t.element&&(i.add(t),i.postWrite(t))},vt=function(e){var t=/^(?:(\w+):\/\/)?(?:(\w+):?(\w+)?@)?([^:\/\?#]+)(?::(\d+))?(\/[^\?#]+)?(?:\?([^#]+))?(?:#(\w+))?/.exec(e);return!!t&&(("http"===t[1]||"https"===t[1])&&!ge.some(function(e){return e===t[4]}))},wt=function(e){if(0!=e&&!G){switch(G=!0,e){case 1:case"Session time out.":swal("Error",t("Session time out."),"error");break;case 2:case"Room was deleted.":swal("Error",t("Room was deleted."),"error");break;case 3:case"Login error.":swal("Error",t("Login error."),"error");break;case"Room not found.":swal("Error",t("Room not found."),"error");break;default:swal("Error",t(e),"error")}window.setTimeout(function(){location.href=location.baseURL},3e3)}},bt=function(){var e=$(this).parents(".talk").find(".dropdown"),t=e.data();t.secret&&t.id!=ne?$t(t):Ct.apply(e)},yt=function(){var e=$(this).parents(".dropdown").data();e.id!==ne&&$t(e)},$t=function(e){pt(e),T.val(e.id)},kt=function(e){if(13==(e.keyCode||e.which)&&!e.ctrlKey&&!e.shiftKey)return e.preventDefault(),o.submit(),!1},Rt=function(){G=!0,re=!0,swal({title:t("Leaving ..."),showConfirmButton:!1}),$.ajax({type:"POST",url:e,data:{leave:"leave"},timeout:4e3}).done(function(e){be();var n=function(){location.replace(e)};swal({title:t("Leaving ..."),type:"warning",showConfirmButton:!1},n),n()}).fail(function(e){ve(),G=!1,re=!1,swal({title:t("Leave error"),type:"error",showConfirmButton:!0}),location.reload()})},xt=function(){if(!DRRR.hasLocalStorage||!FileReader in window)swal({title:"",text:t("Failed to import collections, error code: {1}","1"),type:"error"});else{var e=this.files[0],n=e.name,i=e.size;if(!/\.json$/.exec(n)||i>5242880)swal({title:"",text:t("Failed to import collections, error code: {1}","2"),type:"error"});else{var o=new FileReader;o.readAsText(e),o.onload=function(){try{var e=JSON.parse(this.result),n=box.musicBookmarkPrompt;swal({title:"",text:t("Do you want to retain your existing collections?"),type:"warning",showCancelButton:!0,cancelButtonText:"No"},function(t){for(var i in t||(box.shelf.deleteAll(),b.nextAll().remove()),$("#musicShelf .musicList").children().remove(),e)"dura-imgColl"!==i&&0!==i.indexOf(n)||localStorage.setItem(i,e[i]);Re(),box.shelf.loadItemsFromStorage(),t&&xe(),!w.is(":visible")&&Ot()})}catch(e){swal({title:"",text:t("Failed to import collections, error code: {1}","3"),type:"error"})}finally{l.next().val("")}}}}},St=function(){if(!DRRR.hasLocalStorage||!Blob in window||!saveAs in window)swal({title:"",text:t("Failed to export collections, error code: {1}","1"),type:"error"});else{xe();var e={},n=box.musicBookmarkPrompt;for(var i in localStorage)0===i.indexOf(n)&&(e[i]=localStorage[i]);e["dura-imgColl"]=localStorage.getItem("dura-imgColl"),e=JSON.stringify(e);try{e=new Blob([e],{type:"text/plain"})}catch(n){if(window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,"TypeError"==n.name&&window.BlobBuilder){var o=new BlobBuilder;o.append(e),e=o.getBlob("text/plain")}else{if("InvalidStateError"!=n.name)return void swal({title:"",text:t("Failed to export collections, error code: {1}","2 - Blob unsupported!"),type:"error"});e=new Blob([e],{type:"text/plain"})}}saveAs(e,"drrr-collections.json")}},Ct=function(){var e=$(this).data(),t=a.val();a.focus(),t.length>0?a.val(t+" @"+e.name+" "):a.val(t+"@"+e.name+" ")},_t=function(e,t){for(var n in e){var i=e[n];if(i.id==t)return i}return null},Mt=function(e){var t=$(e).parentsUntil(".dropdown"),n=null;return n=0==t.length?e:t[t.length-1],$(n).data()},Tt=function(){var e=Mt(this);$t(e)},Bt=function(){if(!rn()){var e=$(this).find(".body").height()+30+8,t=$(this).find(".body").outerHeight(),n=(Math.round((180-e)/2),$(this).find(".body").css("background-image"),Math.floor(3*Math.random())),i=null;i=Settings.is("bubbletail")?2==n?"top":1==n?"center":"bottom":"center",1,$(this).find(".body"),$(this).prepend("<div class=tail-wrap><div class=tail-mask></div></div>"),$(this).children(".tail-wrap").addClass(i).css({"background-size":t+"px"})}},Dt=function(){rn()&&Settings.prop("soundeffect",!1),p.find("li:hidden:not(.music)").show();var e=Settings.is("soundeffect")?"sound_on":"sound_off",t=Q?"member_on":"member_off";p.find("li.sound").addClass(e),p.find("li.member").addClass(t)},Nt=function(){j[0].checked=Settings.is("soundeffect"),E[0].checked=Settings.is("bubbletail"),H[0].checked=Settings.is("autoloadimage")},Lt=function(){Settings.is("soundeffect")?(j[0].checked=!1,Settings.prop("soundeffect",!1)):(j[0].checked=!0,Settings.prop("soundeffect",!0))},Pt=function(){Settings.is("bubbletail")?(E[0].checked=!1,Settings.prop("bubbletail",!1)):(E[0].checked=!0,Settings.prop("bubbletail",!0))},It=function(){Settings.is("autoloadimage")?(H[0].checked=!1,Settings.prop("autoloadimage",!1)):(H[0].checked=!0,Settings.prop("autoloadimage",!0))},Ot=function(){w.slideToggle("fast"),y.is(":visible")?y.slideToggle("fast",Ft):jt("fast")},At=function(e){y.slideToggle("fast"),w.is(":visible")?w.slideToggle("fast",Ft):jt("fast")},Ut=function(){Q?($(this).removeClass("member_on"),$(this).addClass("member_off"),Q=!1):($(this).removeClass("member_off"),$(this).addClass("member_on"),Q=!0)},jt=function(e){u.slideToggle(e),a.slideToggle(e),d.slideToggle(e,Ft)},Et=function(){DRRR.isMobile&&g.slideUp("fast")},Ht=function(){g.slideToggle("fast",Ft)},Ft=function(){var e=k.outerHeight(!0);s.css({transform:"translate3d(0, "+e+"px, 0)"}),Waypoint.refreshAll(),DRRR.isMobile||(S.is(":visible")&&(e-=S.outerHeight(!0)),x.is(":visible")&&(e-=x.outerHeight(!0)),g.css("top",e+"px"))},zt=function(e){ce=e,e==ne?(K=!0,g.addClass("is-host")):K=!1,p.find("li.adminSetting")[0]&&(X=!0),K||X?D.show():(B.find("a").tab("show"),D.hide())},Jt=function(e){Z=e,i.isDjMode=e,F[0].checked=e,K||!Z?m.addClass("music_on").show():(y.is(":visible")&&At(),m.removeClass("music_on").hide())},Wt=function(){var n=f.find("input[name=room_name]").val();$.ajax({type:"POST",url:e,data:{room_name:n},timeout:4e3}).done(function(e){swal({title:t("Room"),text:e,timer:1e3}),Gt(n),Et()})},Vt=function(){var n=I.val();""===n.trim()&&(n=" "),$.ajax({type:"POST",url:e,data:{room_name:n},timeout:4e3}).done(function(e){swal({title:t("Room"),text:e,timer:1e3}),Gt(n),Et()})},Gt=function(e){document.title=e+" - "+t("Durarara like chat room")},qt=function(){var n=A.val();""===n.trim()&&(n=" "),$.ajax({type:"POST",url:e,data:{room_description:n},timeout:4e3}).done(function(e){swal({title:t("Room Description"),text:e,timer:1e3}),Et()})},Yt=function(){var n=h.find("input[name=room_limit]").val();$.ajax({type:"POST",url:e,data:{room_limit:n},timeout:4e3}).done(function(e){swal({title:t("Room"),text:e,timer:1e3}),Et()})},Zt=function(){$.ajax({type:"POST",url:e,data:{dj_mode:F[0].checked},timeout:4e3}).done(function(e){swal({title:t("Room"),text:e,timer:1e3})})},Kt=function(){X?Qt.apply(this,["new_host",Mt(this)]):Xt.apply(this,["new_host",t("Are you sure to handover host rights?")])},Xt=function(e,n){var i=this,o=Mt(this);swal({title:t("Are you sure?"),text:n,type:"warning",showCancelButton:!0,confirmButtonText:t("Yes"),cancelButtonText:t("Cancel")},function(t){t&&Qt.apply(i,[e,o])})},Qt=function(n,i){i=null==i?Mt(this):i;var o={};o[n]=i.id,$.ajax({type:"POST",url:e,data:o,timeout:4e3}).done(function(e){be(),e&&"string"==typeof e&&window.setTimeout(function(){swal(t("Warning"),e,"warning")},100)}).fail(function(e){ve(),swal(t("Error"),e.responseText,"error")}).always(function(){Et()})},en=function(){Xt.apply(this,["report_user",t("Are you sure to report this user to Moderators?")])},tn=function(){Xt.apply(this,["report_and_ban_user",t("Are you sure to report to Moderators and ban this user?")])},nn=function(){Xt.apply(this,["ban",t("Are you sure to ban this user?")])},on=function(){Xt.apply(this,["banip",t("Are you sure to ban this user's IP?")])},an=function(){var n=Mt(this);$.ajax({type:"POST",url:e,data:{unban:n.id,userName:n.name},timeout:4e3}).done(function(e){e&&swal({title:t("Room"),text:e,timer:1e3})}).always(function(){Et()})},sn=function(){Qt.apply(this,["kick"])},rn=function(){return!1},ln=function(){if(DRRR.hasLocalStorage){var e=Settings.prop("message");a.val(e),a.on("change keyup paste",function(){var e=a.val();Settings.prop("message",e)})}},cn=function(){DRRR.hasLocalStorage&&Settings.remove("message")},un=function(){dragula([v.get(0)],{direction:"horizontal",mirrorContainer:v.next().get(0),moves:function(e,t,n,i){return"IMG"===n.tagName}}).on("drag",function(e,t){var n=w.height();w.bind("touchend",function(e){w.unbind("touchmove")}),w.bind("mousemove touchmove",function(e){var t=w.position().top;DRRR.isMobile&&(e.clientY=e.originalEvent.targetTouches[0].clientY);var i=e.clientY-t,o=.65*n,a=.35*n;if((DRRR.isMobile||1==e.which)&&(i<o||i>a)){var s=i-n/2;s*=.1,w.scrollTop(s+w.scrollTop())}else w.unbind("mousemove touchmove")})})},dn=function(){$(".room-input-wrap textarea").characterCounter({limit:"140"})},mn=function(){var e=(new Date).getTime(),t=logoutDelay-e+1e3*se;t>0?(r.addClass("dropdown-item-unclickable"),setTimeout(function(){r.removeClass("dropdown-item-unclickable"),r.click(function(){Rt()})},t>logoutDelay?logoutDelay:t)):r.click(function(){Rt()})};function pn(e){e=e||0;$(window).scrollTop(e)}function fn(e){var t=document.createElement("link"),n=document.getElementById("dynamic-favicon");t.id="dynamic-favicon",t.rel="shortcut icon",t.href=e,n&&document.head.removeChild(n),document.head.appendChild(t)}document.head=document.head||document.getElementsByTagName("head")[0],function(){var z,W;z=null,W=null,"true"==$.cookie("drrr-should-bypass")?(z=$.cookie("drrr-bypass-result"),$.ajaxSetup({xhrFields:{withCredentials:!0}}),W="//"+z+"/"):(z=location.baseURL,W=location.baseURL+"/"),e=W+"room/?ajax=1",n=W+"json.php",window.room?room.option=function(e){return room.hasOwnProperty(e)&&room[e]}:swal(t("Room Error"),t("Reload this page to update."),"error"),s=$("#talks"),maxIdleTime/60,logoutDelay*=1e3,w=$("#image_panel"),v=w.find(".row").first(),b=$("#no_images"),y=$("#music_pannel"),k=$(".message_box"),o=$("#message"),a=$("#message textarea"),M=$("#url-input"),T=$("#to-input"),r=$(".do-logout"),l=$(".import-coll"),c=$(".export-coll"),u=$(".room-submit-btn"),d=$("#url-icon"),m=$("#musicShare"),$("dl.talk dt"),p=$("ul.menu"),f=$(".room-title-name"),B=$("#settings-info-tab"),$("#settings-user-tab"),D=$("#settings-room-tab"),N=$("#settings-info-room-name"),L=$("#settings-info-room-description"),P=$("#settings-info-room-uptime"),$("#settings-room-name"),I=$("#form-settings-room-name"),O=$("#form-settings-room-name-save"),$("#settings-room-description"),A=$("#form-settings-room-description"),U=$("#form-settings-room-description-save"),j=$("#form-settings-system-sound"),E=$("#form-settings-bubble-tail"),H=$("#form-settings-autoload-image"),F=$("#form-settings-music-sharemode"),h=$(".room-title-capacity"),g=$("#setting_pannel"),R=$("#user_list"),x=$("#connection-indicator"),S=$("#unread-indicator"),C=$("#unread-indicator .counter"),Y=room.option("gameRoom"),room.option("music")&&box.init(),room.talks&&room.talks.reverse(),ne=profile.id,ie=profile.name,oe="@"+profile.name,ae=new RegExp(escapeForRegExp(oe)+" "),profile.icon,profile.tripcode,se=profile.loginedAt,Y&&profile.player,Me(),(i=new DRRRClient(s,"►►",!0)).isGameRoom=Y,Ke(room),i._effectGameRoom(room.description),i.isFirst=!1,"devicePixelRatio"in window?window.devicePixelRatio:1,ee="macgap"in window,_=140,"undefined"!=typeof GlobalMessageMaxLength&&(_=GlobalMessageMaxLength),Ie(),Dt(),rt(),Gt(f.text()),DRRR.isMobile||Ht(),ln(),useComet?Ze():(qe(),setInterval(function(){Ye()},2e3));ye(),Nt(),Re(),un(),$.each($(".bubble"),Bt),$(".room-input-wrap textarea").textcomplete([{match:/\B@(\w*)$/,search:function(e,t){t($.map(fe,function(t){return t.name===ie?void 0:0===t.name.toLowerCase().indexOf(e.toLowerCase())?t:null}))},index:1,replace:function(e){return"@"+e.name+" "},template:function(e,t){return $("<div />",{class:"name-wrap"}).append($("<span />",{class:"symbol symbol-"+e.icon})).append($("<span />",{class:"name",text:e.name})).prop("outerHTML")}}],{maxCount:30,debounce:100}),dn(),s.waypoint(function(e){"up"===e&&(S.hide(),C.text("0"))},{offset:function(){return k.outerHeight(!0)}}),$(window).on("blur focus",function(e){var t=$(this).data("prevType");if(t!=e.type)switch(e.type){case"blur":J=!1;break;case"focus":J=!0,fn(location.baseURL+"/favicon.ico")}$(this).data("prevType",e.type)}),mn()}()});var Box=function(){var e=!0,n=!0;this.musicBookmarkPrompt="music-book-mark-";var i,o,a,s,r=0,l=null,c=.8,u=!1,d=null,m={xiami:/(?:https?)(?::\/\/)(?:www\.)?(?:xiami\.com\/song\/)(\w+)/i,netease:/(?:https?)(?::\/\/)(?:m\.)?(?:music\.163\.com)(?:\/#)?(?:\/m)?(?:\/song)(?:\?id=|\/)(\w+)/i,bilibili:/(?:https?)(?::\/\/)(?:www\.bilibili)(?:.com|.tv)(\/video)?(\/av)/i,tencent:/(?:https?)(?::\/\/)(?:y\.qq\.com)(?:\/n)?(?:\/yqq)?(?:\/song)(?:\?id=|\/)(\w+)/i,baidu:/(?:https?)(?::\/\/)(?:music\.taihe\.com\/song\/)(\w+)/i,kugou:/(?:https?)(?::\/\/)(?:www\.kugou\.com\/song\/)(?:#hash=)?([0-9A-F]{32})/i},p={xiami:"虾",netease:"易",bilibili:"Ｂ",tencent:"Ｑ",baidu:"千",kugou:"狗"},f=function(e){for(source in m)if(regex=m[source],regex.test(e))return source;return null},h=null,g=null,v=null,w=null,b=null,y=null,k=null,R=null,x=null,S=null,C=null,_=null,M=null,T=null,B=null,D=null,N=null;this.clearSession=null,this.switchNoMusic=null,this.playMusic=null,this.clickSettings=null,this.changeVolume=null,this.pauseSwitch=null,this.playNext=null,this.playNext=null,this.addNP=null,this.np=null,this.init=null;var L=null,P=null,I=null,O=!1,A=location.baseURL+"/redirect.php?url=";this.shelf=null,this.collectMusic=function(e){var t=DRRRClientBehavior.literalMusicTitle(e);I.addMusic(t,e.shareURL),P.addMusicItem(t,e.shareURL),window.ga&&ga("send","event",{eventCategory:"Music",eventAction:"Bookmark",eventLabel:t})},this.alloc=function(){return d=[],I=new E,P=(new H).alloc(),L=(new j).alloc(),this.shelf=P,this.player=L,this.clearSession=M,this.switchNoMusic=T,this.playMusic=g,this.clickSettings=B,this.changeVolume=w,this.pauseSwitch=v,this.playNext=h,this.addNP=D,this.init=N,this.np=function(){return l},U(),this};var U=function(){e="sessionStorage"in window&&"localStorage"in window;try{window.sessionStorage["music-test"]="music-test",window.localStorage["music-test"]="music-test",window.sessionStorage.removeItem("music-test"),window.localStorage.removeItem("music-test")}catch(t){e=!1}};M=function(){C(),e&&(sessionStorage.refreshed="false")},i=function(e,i){if(!(e.playURL&&e.name&&e.playURL.length>0&&e.name.length>0))return d.length-1;var o=new function(e){this.name=DRRRClientBehavior.literalMusicTitle(e),this.url=e.playURL,this.shareURL=e.shareURL,this.originalUrl=this.shareURL;var i=null,o=this,a=null,s=function(){return o.howl.seek()},r=function(){return o.howl.duration()},u=function(){return s()/r()};i=new Howl({autoplay:!1,src:[o.url],html5:!0,volume:O?1:c,onload:function(){O&&visualizer.play(this._sounds[0]._node)},onend:function(){clearInterval(a),L.progress.setValue(100*u()),L.progress.setActive(!1),O&&visualizer.stop()},onloaderror:function(e,n){if("No audio support."!=n&&("No codec support for selected audio sources."!=n||-1===o.url.indexOf(A))){switch(n=n||"Unknown"){case 1:n="fetching process aborted by user";break;case 2:n="error occurred when downloading";break;case 3:n="error occurred when decoding";break;case 4:n="URL is incorrect or audio/video not supported"}O&&visualizer.stop(),swal(t("Music: "),t("Audio cannot be loaded: {1}",o.name)+"\n\n"+t("Error: {1}",n),"warning")}},onplayerror:function(){i.once("unlock",function(){i.play()})}});var m=function(){d.forEach(function(e){e!==o&&null!=e&&null!=e.howl&&e.stop()})};return this.time=s,this.setTime=function(e){var t=new Date;0==r()?i.once("play",function(){var n=(new Date-t)/1e3;i.seek(e+n)}):e<=r()?i.seek(e):i.stop()},this.play=function(){i.play(),O&&visualizer.resume(),m(),n=!1,l=o,L.progress.setValue(100*u()),setTimeout(function(){setTimeout(function(){L.progress.setActive(!0)},51),a=setInterval(function(){L.progress.setValue(100*u())},1e3)},50)},this.pause=function(){i.pause(),O&&visualizer.pause(),n=!0,L.progress.setActive(!1),clearInterval(a)},this.stop=function(){n=!0,setTimeout(function(){i.stop(),L.progress.setActive(!1),L.progress.setValue(0),clearInterval(a)},100)},this.howl=i,this.unload=function(){clearInterval(a),this.howl.unload()},this}(e);if(d.push(o)>10){var a=d.shift();try{a.unload()}catch(e){console}}return d.length-1};var j=function(){var e,n=null,i=null,o=!1,a=null,s=null,r=null;this.progress=null,this.init=null,this.changeModeString=null,this.clickSettings=null,this.showButtons=null,this.alloc=function(){return this.changeModeString=r,this.clickSettings=s,this.showButtons=a,this.changeNowPlayingText=d,n=new l,this.progress=n,this.init=u,this},e=function(){i='      <div id="musicBox" class="select-none">        <div class="player-inner-wrap">           <div class="progress-music" role="progressbar"></div>          <div id="control">            <a id="play-or-pause" class="control-button play" href="javascript:void(0);" onclick="box.pauseSwitch()"><i class="icon icon-pause"></i><i class="icon icon-play"></i></a>            <a id="bookmark-toggle" class="control-button"><i class="icon icon-list"></i></a>            <a id="do-not-disturb" class="control-button" href="javascript:void(0);" onclick="box.doNotDisturbSwitch()"></a>          </div>          <div class="volume"><input type="range" step="1" id="volume" min="0" max="100" value="'+100*c+'" onchange="box.changeVolume(this.value)" oninput="box.changeVolume(this.value)"></div>          <div id="np">            <span id="np-mode"></span>             <span id="np-text" class="select-text"></span>          </div>        </div>      </div>',$("body").append(i)};var l=function(){return this.setActive=function(e){var t=$(".progress-music");e?t.addClass("active"):t.removeClass("active")},this.setValue=function(e){var t=$(".progress-music");$(t).attr("aria-valuenow",e).css("width",e+"%")},this},u=function(){Settings.prop("musicvol")&&(c=.01*Settings.prop("musicvol")),e()};a=function(){$("#play-or-pause").removeClass("playing"),$("#play-next").text("→"),$("#add-this-music")};var d=function(e,t){var n=$("#musicBox #np");n.find(".source").remove();var i=f(t);if(i){var o=$("<span />").addClass("source").addClass(i).text(p[i]);n.find("#np-mode").after(o)}n.find("#np-text").text(e)};return s=function(e){var t=$("#musicBox .settingPanel"),n=$(t).find(".settingContentContainer");o?(o=!1,$(t).removeClass("showSetting"),$(t).addClass("hideSetting"),$(n).removeClass("showContent"),$(n).addClass("hideContent")):(o=!0,$(t).removeClass("hideSetting"),$(t).addClass("showSetting"),$(n).removeClass("hideContent"),$(n).addClass("showContent"))},r=function(e){if("number"==typeof e){var n=null;n=0==e?"Stopped":1==e?"Paused":2==e?"Playing":3==e?"Offline":"Unknown",e=t(n)+":"}$("#musicBox #np #np-mode").text(e)},this};D=function(){if(null!=l){var e=$("#musicBox #np-text").text(),t=null;null==l.originalUrl?(t=l.url,O&&(t=t.replace(A,""))):t=l.originalUrl,I.addMusic(e,t),P.addMusicItem(e,t),window.ga&&ga("send","event",{eventCategory:"Music",eventAction:"Bookmark",eventLabel:e})}},N=function(){e&&"true"==sessionStorage.refreshed&&(u=!0),"boolean"==typeof box_inited&&1==box_inited||(Howler.mobileAutoEnable=!0,L.init(),b(),x(),setTimeout(y,10),P.init(),$(document).trigger("music-loaded")),box_inited=!0},x=function(){var t=!1;$(window).bind("unload",function(){t?(e&&(sessionStorage.refreshed="true"),S()):(e&&(sessionStorage.refreshed="false"),C())}),$(window).bind("beforeunload",function(){t=!0})},y=function(){u?R():k(),C()},k=function(){if(room&&room.np){var e=DRRRClient.upgradeMusic(room.np);g(e)}},R=function(){if(e&&sessionStorage.hasOwnProperty("music-status-session_music")){var t=JSON.parse(sessionStorage["music-status-session_music"]),n=t.name,i=t.url,o=t.oriURL,a=t.time,s=t.npMode,r=!1;"true"==sessionStorage["music-status-isPausing"]&&(r=!0),i&&i.length>0&&($("#musicBox #np #np-mode").text(s),g({name:n,playURL:i,shareURL:o}),l.setTime(a),r&&(O&&visualizer.pause(),l.stop(),$("#play-or-pause").addClass("playing"),L.changeModeString(1)))}},S=function(){null!=l&&l.name.length>0&&l.url.length>0&&e?(sessionMusicItem={name:l.name,url:l.url,oriUrl:l.originalUrl,time:l.time(),isPausing:n.toString(),npMode:$("#musicBox #np #np-mode").text()},sessionStorage["music-status-session_music"]=JSON.stringify(sessionMusicItem)):C()},C=function(){if(e)for(var t in sessionStorage)t.match("music-status-")&&sessionStorage.removeItem(t)},s=function(e){Settings.is("mute-fancies")||"string"==typeof e&&(e.search(/snow|christmas|Young And Beautiful/i)>-1?(_(),snowStorm.start()):e.search(/firework|新年/i)>-1?(_(),firework.start()):e.search("Lonely - Akon")>-1||e.search(/回梦游仙|迴梦游仙/)>-1&&Howler.usingWebAudio&&!O&&(_(),visualizer.setup(c),O=!0))},_=function(){"fancyLoaded"in window&&1==fancyLoaded||$("<script />",{src:location.baseURL+"/js/extra.min.js"}).appendTo("head")},b=function(){$("#musicShare").addClass("music_on").show(),$("#musicShare").click(function(){expose.toggleMusic()})},a=function(e){return e>d.length-1||e<0?null:d[e]},o=function(e){var t=a(e);t?(t.play(),L.showButtons(),L.changeNowPlayingText(t.name,t.shareURL)):console},h=function(){r<d.length?(o(r),r++):(o(r=0),r++),L.changeModeString(3)},g=function(e,n){var r=function(){s(e.name),O&&-1===e.shareURL.indexOf(A)&&(e.shareURL=A+e.shareURL);var t=i(e);if(o(t),n&&n.mode)switch(n.mode){case"self":L.changeModeString(3)}else L.changeModeString(2);if(n&&n.time){var r=n.time,l=a(t);if(l){var c=new Date/1e3-r;return c>0&&l.setTime(c),l}}};return DRRR.isMobile?swal({title:t("Notice"),text:t("A sound is casted, would you like to play?"),showCancelButton:!0},r):r()},v=function(){n?null!=l&&(l.play(),$("#play-or-pause").removeClass("playing"),L.changeModeString(3)):(l.pause(),$("#play-or-pause").addClass("playing"),L.changeModeString(1))},w=function(e){c=.01*e,Settings.prop("musicvol",e),l&&(O?visualizer.changeVolume(c):l.howl.volume(c))};var E=function(){this.nameFor=function(e){return"music-book-mark-"+e},this.deleteMusic=function(e){var t=this.nameFor(e);localStorage.removeItem(t)},this.addMusic=function(e,t){var n=this.nameFor(e);localStorage[n]=t}},H=function(){var n,i=null,o=null,a=null,s=null,r=null,l=null,c=null,u=null,d=null,m=null,h=!1;this.init=null,this.loadItemsFromStorage=null,this.addMusicItem=null,this.deleteMusicItem=null,this.deleteAll=null,this.clickShare=null,this.clickDelete=null,this.showThisButtons=null,this.hideThisButtons=null,this.show=null,this.hide=null,this.toggle=null,this.alloc=function(){return i='      <div id="musicShelf" class="musicShelf select-none">        <div class="musicList"></div>      </div>      ',this.addMusicItem=o,this.loadItemsFromStorage=v,this.deleteMusicItem=a,this.deleteAll=g,this.clickShare=s,this.clickDelete=r,this.showThisButtons=l,this.hideThisButtons=c,this.show=u,this.toggle=m,this.hide=d,this.init=w,this},n=function(){var e=[];for(var t in localStorage){var n=t.match("^music-book-mark-(.+)");if(null!=n)e[n[1]]=localStorage[t]}return e};var g=function(){$("#musicShelf .musicList").children().each(function(e,t){I.deleteMusic($(t).attr("music"))})},v=function(){var e=n();for(var t in e=function(e,t){var n,i,o=[],a={};for(n in e)o.push(n);if(o.sort(function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())}),"desc"===t)for(i=o.length-1;i>=0;i--)a[o[i]]=e[o[i]];else for(i=0;i<o.length;i++)a[o[i]]=e[o[i]];return a}(e,"desc"))this.addMusicItem(t,e[t])},w=function(){e&&($("body").prepend(i),$("#musicBox #control").prepend('        <a id="add-this-music" class="control-button" href="javascript:void(0);" onclick="box.addNP()"><i class="icon icon-heart"></i></a>      '),this.loadItemsFromStorage(),d(),$("#bookmark-toggle").click(this.toggle))};o=function(e,n){var i=!1;$(".musicItem").each(function(){if($(this).attr("music")===e)return i=!0,!1}),i&&(e+="(new)");var o=f(n);$("#musicShelf .musicList").prepend('\t\t\t\t<div class="musicItem" music="'+e+'" url="'+n+'" onClick="return true;">\t\t\t\t\t'+(o?'<div class="source '+o+'">'+p[o]+"</div>":"")+'\t\t\t\t\t<div class="name">'+e+'</div>\t\t\t\t\t<div class="button delete" onclick="box.shelf.clickDelete(this)">'+t("Delete")+'</div>\t\t\t\t\t<div class="button share" onclick="box.shelf.clickShare(this)">'+t("Share")+"</div>\t\t\t\t</div>\t\t\t"),u(),setTimeout(function(){d()},1e3)},a=function(e){var t=$("#musicShelf .musicList").find('div[music="'+e+'"]');t&&$(t).slideUp(function(){$(t).remove()})},s=function(e){var t=$(e).parent(),n=$(t).attr("music"),i=$(t).attr("url"),o=$("#music_pannel"),a=$(o).find('input[name="music_name"]'),s=$(o).find('input[name="music_url"]');$(a).val(n),$(s).val(i),expose.toggleMusic(),$('#music_pannel input[name="play"]').click(),$(a).val(""),$(s).val("")},r=function(e){var n=$(e).parent(),i=$(n).attr("music");confirm(t("Are you sure you want to delete bookmark: {1} ?",i))&&(this.deleteMusicItem(i),I.deleteMusic(i),window.ga&&ga("send","event",{eventCategory:"Music",eventAction:"Remove",eventLabel:i}))},l=function(e){},c=function(e){},u=function(){h=!0;var e=$("#musicShelf");$(e).addClass("showShelf").removeClass("hideShelf")},d=function(){h=!1;var e=$("#musicShelf");$(e).removeClass("showShelf").addClass("hideShelf")},m=function(){$("#musicShelf");h?d():u()}};return B=function(e){this.player.clickSettings(e)},T=function(e){alert(e)},this},box=(new Box).alloc(),app={common:function(){document.title="DALLARS",$("html").addClass("mac")},root:function(){document.title=t("DALLARS")},lounge:function(){document.title=t("Lounge")},room:function(){document.title=t("Room");document.addEventListener("wake",function(){},!0),document.addEventListener("sleep",function(){},!0),document.addEventListener("appActivated",function(e){expose.clearUnreadMessage()},!0)}};if("macgap"in window){var path=location.pathname;app.common(),"/"==path?app.root():"/lounge/"==path?app.lounge():"/room/"==path&&app.room()}function rootMain(){addDirectJoinIndicator(),$("#home-extra-toggle").on("click",function(){$("#home-extra").toggle()}),$("a[href*=#]:not([href=#])").click(function(){var e=$(this.hash);if((e=e.length?e:$("[name="+this.hash.slice(1)+"]")).length)return $("html,body").animate({scrollTop:e.offset().top},600),!1}),$(".login-icons-list li:first-child input").prop("checked",!0).prev().addClass("active"),$(".login-icons-list li input").on("click",function(){$(".login-icons-list .user-icon").removeClass("active"),$(this).prev().addClass("active")});var e=$("#form-ap-select");if(ap.isBypass()){var t=!1,n=ap.currentAP().domain;e.find("option").each(function(){if($(this).val()==n)return t=!0,!1}),t||"true"==$.cookie("drrr-bypass-debug")?e.val(n):ap.cancelBypass()}e.on("change",function(){var e=$(this).find(":selected"),t={name:e.text().trim(),domain:e.val()};ap.setBypass(t)})}function addDirectJoinIndicator(){var e,n=$.url("?id");n&&$("form").before((e=n,$("<div />").addClass("to-join").append($("<span />").text(t("Joining room: {1}",e))).append($("<a />").text(" ("+t("Cancel")+")").click(function(){document.location.search=""}).addClass("needsclick").attr("href","#"))))}function accessPointMain(){var e=!0,n=10,i=!1;$("#start-button").on("click",function(){o(!0),$("#result").empty(),drrrRoundTrip.benchmark(aps,function(t){o(!1);var n={score:0};for(var a in t){var r=t[a],l={};r.score>n.score&&(n=r),e&&(l.detail=!0,l.latency=r.latency,l.loss=r.loss),r==n&&(l.best=!0),$("#result").append(s(r.name,r.score,l))}i&&window.ap.setBypass(n)},function(e){a(e)},{testTime:n})}),$("#form-show-detail").on("change",function(){e=this.checked}),$("#form-percise-test").on("change",function(){n=this.checked?100:10}),$("#form-auto-switch").on("change",function(){i=this.checked});var o=function(e){e,e?$("#start-button").addClass("disabled"):$("#start-button").removeClass("disabled")},a=function(e){var t=$("#process");e>0&&e<100?$("#process").addClass("progress-bar-striped").addClass("active"):$("#process").removeClass("progress-bar-striped").removeClass("active"),t.width(e+"%"),t.attr("aria-valuenow",e)},s=function(e,n,i){var o="";o=n>85?"list-group-item-success":n>50?"":n>20?"list-group-item-warning":"list-group-item-danger";var a=$("<div />",{class:"list-group-item result-ap "+o}).append($("<span />",{class:"badge score",text:n.toFixed(1)})),s=!0;return null!=i&&("best"in i&&i.best&&a.append($("<span />",{class:"badge best",text:"best"})),"detail"in i&&i.detail&&(s=!1,a.append($("<h4 />",{class:"list-group-item-heading name",text:e})).append($("<p />",{class:"list-group-item-heading latency",text:t("Latency:\t\t{1}",i.latency.toFixed(1)+"ms")})).append($("<p />",{class:"list-group-item-heading loss",text:t("Packet Loss:\t\t{1}",i.loss.toFixed(1)+"%")})))),s&&a.append($("<p />",{class:"list-group-item-heading name",text:e})),a}}window.ap={isBypass:function(){return"true"==$.cookie("drrr-should-bypass")},cancelBypass:function(){$.removeCookie("drrr-should-bypass"),$.removeCookie("drrr-bypass-name"),$.removeCookie("drrr-bypass-result")},setBypass:function(e){e.domain&&"direct"!=e.domain?($.cookie("drrr-should-bypass","true",{expires:60}),$.cookie("drrr-bypass-name",e.name,{expires:60}),$.cookie("drrr-bypass-result",e.domain,{expires:60})):window.ap.cancelBypass()},currentAP:function(){return{name:$.cookie("drrr-bypass-name"),domain:$.cookie("drrr-bypass-result")}}},$(document).ready(function(){location.conformTo("/")?rootMain():location.conformTo("/access_point")&&accessPointMain()});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var DRRRClient=function(){function DRRRClient(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"►►",n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];_classCallCheck(this,DRRRClient),this.talksElement=$(e),this.prompt=t,this.isFirst=n,DRRR.isMobile&&(DRRR.messageLimit=DRRR.messageLimitMobile)}return _createClass(DRRRClient,[{key:"write",value:function(e){switch(e.translated=this._translateArray(e.message),e.type){case"room-profile":this.writeNoneBehavior(e);break;case"new-description":this.writeRoomDescription(e);break;case"script":this.writeScript(e);break;case"message":this.writeMessage(e);break;case"roll":this.writeRoll(e);break;case"player":this.writePlayer(e);break;case"alive":this.writeAlive(e);break;case"leave":case"join":case"new-host":this.writeSingleBehavior(e);break;case"me":this.writeMe(e);break;case"kick":case"ban":case"unban":this.writeSingleBehavior(e,"to");break;case"system":this.writeSystem(e);break;case"music":this.writeMusic(e);break;case"async-response":this.writeResponse(e);break;default:this.writeNoneBehavior(e)}e.element&&(this.add(e),this.isFirst||this.postWrite(e))}},{key:"_formBasicNode",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=$("<div />",{class:"talk",id:e.id}).addClass(e.type);return n&&o.addClass("system"),t&&o.addClass("select-text"),i&&o.attr(i),e.element=o,e.element}},{key:"_appendNodeContent",value:function(e){e.element.append(e.translated[0]);for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return n.forEach(function(t,n){e.element.append(t),t?e.element.append(e.translated[n+1]):e.translated[n+2]=e.translated[n+1]}),e.element}},{key:"_translateArray",value:function(e){return(this.prompt+" "+t(e)).split(/{\d+}/g)}},{key:"_formMusicNode",value:function(e){var t={xiami:"虾",netease:"易",bilibili:"Ｂ",tencent:"Ｑ",baidu:"千",kugou:"狗"};e||(e={name:"ERROR",error:!0});var n={"data-toggle":"dropdown",class:"name",text:DRRRClientBehavior.literalMusicTitle(e)};e.error&&(n.style="color: gray");var i=void 0;return i=t.hasOwnProperty(e.source)?{class:"source",text:t[e.source]}:{class:"no-source"},$("<span />",{class:"dropdown music"}).data(e).append($("<span />",i)).append($("<span />",n)).append($("<ul />",{class:"dropdown-menu",role:"menu"}))}},{key:"_formUserNode",value:function(e){if("all"===e)return"";e||(e={name:"ERROR",id:null,error:!0});var t={"data-toggle":"dropdown",class:"name",text:e.name};return e.error&&(t.style="color: gray"),$("<span />",{class:"dropdown user"}).data(e).append($("<span />",t)).append($("<ul />",{class:"dropdown-menu",role:"menu"}))}},{key:"_formIconNode",value:function(e){return e&&"all"!==e?$("<span />",{class:"symbol symbol-"+e.icon}):""}},{key:"_htmlEncode",value:function(e){return document.createElement("a").appendChild(document.createTextNode(e)).parentNode.innerHTML}},{key:"_formChatContent",value:function(e,t,n,i){var o=(n.message||"").toString().split("\n").filter(function(e){return""!==e.trim()}),a=$("<p />",{class:"body select-text"}),s=o.length>10?10:o.length-1;if(o.forEach(function(e,t){e.split("  ").forEach(function(e,t){t&&a.append("&nbsp;&nbsp;"),a.append(document.createTextNode(e))," "===e&&a.append("&nbsp;")}),s>t&&a.append($("<br>"))}),n.url){var r=this._htmlEncode(n.url),l=/[^/]+\.(bmp|jpg|jpeg|png|svg|gif)/i.exec(r);if(l&&window.expose)expose.formChatImageContent(a,r,l[0],l[1]);else{var c=$("<a />",{class:"message-link bstooltip",text:"URL",title:r,href:r,target:"_blank"});$(a).append(c)}}var u=$("<dd />").append($("<div />",{class:"bubble"}).append(a)),d=$("<dt />",{class:"dropdown user"}).data(t).data(i).append($("<div />",{class:"avatar"}).addClass("avatar-"+t.icon).addClass(t.admin?"is-mod":"")).append($("<div />",{class:"name","data-toggle":"dropdown"}).append($("<span />",{text:""+t.name,class:"select-text"}))).append($("<ul />",{class:"dropdown-menu",role:"menu"}));i.secret&&profile.id==t.id&&u.append($("<div />",{class:"secret-to-whom"}).addClass(!1===i.to.alive?"dead":"").append($("<span />",{class:"to"})).append($("<div />",{class:"dropdown user"}).data(i.to).append($("<div />",{"data-toggle":"dropdown",class:"name"}).append($("<span />",{class:"symbol symbol-"+i.to.icon})).append($("<span />",{class:"select-text"}).text(i.to.name))).append($("<div />",{role:"menu",class:"dropdown-menu"}))));var m=$("<dl />",{class:"talk",id:e}).append(d).append(u).addClass(t.icon);return i.secret&&m.addClass("secret"),t.admin&&m.addClass("is-mod"),t.hasOwnProperty("player")&&m.addClass(t.player?"player":"non-player"),t.hasOwnProperty("alive")&&m.addClass(t.alive?"alive":"dead"),m}},{key:"writePlayer",value:function(e){this._formBasicNode(e,!0,!0,{"data-player":e.player}),this._appendNodeContent(e,this._formUserNode(e.to),t(e.player?"player":"non-player"))}},{key:"writeAlive",value:function(e){this._formBasicNode(e,!0,!0,{"data-alive":e.alive}),this._appendNodeContent(e,this._formUserNode(e.to),t(e.alive?"alive":"dead"))}},{key:"writeResponse",value:function(e){return this.isFirst||e.to_me&&(e["stop-fetching"]?($(window).trigger("stop-fetching.kit.drrr"),swal({title:t(e.title),text:t(e.message),type:e.level},function(){$(window).trigger("continue-fetching.kit.drrr")})):swal({title:t(e.title),text:t(e.message),type:e.level})),this.writeNoneBehavior(e)}},{key:"writeScript",value:function writeScript(chat){if(!this.isFirst&&("all"==chat.to||chat.to_me))try{eval(chat.script)}catch(e){swal(e)}return this.writeNoneBehavior(chat)}},{key:"writeNoneBehavior",value:function(e){this._formBasicNode(e).addClass("hide")}},{key:"writeRoomDescription",value:function(e){this._formBasicNode(e,!0),this._appendNodeContent(e,this._formUserNode(e.from),escapeHtml(e.description))}},{key:"writeMe",value:function(e){this._formBasicNode(e,!0),this._appendNodeContent(e,$("<span />").append(this._formIconNode(e.from)).append(this._formUserNode(e.from)),escapeHtml(e.content))}},{key:"writeSingleBehavior",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"user";this._formBasicNode(e),this._appendNodeContent(e,this._formUserNode(e[t]))}},{key:"writeSystem",value:function(e){this._formBasicNode(e),this._appendNodeContent(e)}},{key:"writeRoll",value:function(e){this._formBasicNode(e,!0),this._appendNodeContent(e,this._formUserNode(e.from),this._formUserNode(e.to))}},{key:"writeMusic",value:function(e){DRRRClient.upgradeMusic(e.music);var t={time:e.music.time};this.isFirst||DRRRClientBehavior.playMusic(e.music,t),this._formBasicNode(e,!0,!0).data(e.music),this._appendNodeContent(e,this._formUserNode(e.from),this._formMusicNode(e.music))}},{key:"writeMessage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!this._shouldBeAlreadyWrittenFast(e)){t=t||e.from;var n={secret:e.secret};e.secret&&(n.to=e.to);var i=this._formChatContent(e.id,t,{message:e.message,url:e.url},n);return e.element=i,i}}},{key:"_shouldBeAlreadyWrittenFast",value:function(e){return Boolean(!e.is_fast&&e.is_me&&!this.isFirst&&!(e.url||e.secret))}},{key:"add",value:function(e){$(this.talksElement).prepend(e.element)}},{key:"postWrite",value:function(e){switch(e.type){case"room-profile":case"script":case"async-response":break;case"message":DRRRClientBehavior.ringSoundCommon(),this._effectBaloon(e.element),e.is_me||(expose.checkInMessage(e.message)?expose.checkPermitionAndShowNotification(e.message,e.from.name,e.from.icon,!1):e.secret&&expose.checkPermitionAndShowNotification(e.message,e.from.name,e.from.icon,!0)),DRRRClientBehavior.newMessageAppended(e.element,!0),this._weepMessages();break;case"leave":DRRRClientBehavior.ringSoundLogout(),this._weepMessages();break;case"roll":(e.is_me||e.to_me)&&expose.checkPermitionAndShowNotification(e.message,e.from.name,e.from.icon,!1),DRRRClientBehavior.ringSoundSystem(),this._weepMessages();break;case"new-description":this._effectGameRoom(e.description),DRRRClientBehavior.ringSoundSystem(),this._weepMessages();break;case"me":case"join":case"kick":case"ban":case"unban":case"new-host":case"player":case"alive":DRRRClientBehavior.ringSoundSystem(),this._weepMessages();break;case"music":DRRRClientBehavior.newMessageAppended(e.element,!0),DRRRClientBehavior.ringSoundCommon()}}},{key:"_effectBaloon",value:function(e){var t=$(e).find(".bubble .body:first"),n=($(".bubble").parent(),t.parent());$.each(n,this._addTail),this.isFirst||(DRRR.isMobile?n.parent().addClass("bounce-mobile"):n.parent().addClass("bounce"))}},{key:"_addTail",value:function(){var e=$(this).find(".body").height()+30+8,t=$(this).find(".body").outerHeight(),n=(Math.round((180-e)/2),$(this).find(".body").css("background-image"),null);if(DRRRClientBehavior.checkBubbleTail())switch(Math.floor(3*Math.random())){case 1:n="center";break;case 2:n="top";break;default:n="bottom"}else n="center";$(this).find(".body"),$(this).prepend("<div class=tail-wrap><div class=tail-mask></div></div>"),$(this).children(".tail-wrap").addClass(n).css({"background-size":t+"px"})}},{key:"_weepMessages",value:function(){for(;$(this.talksElement).find(".talk").length>DRRR.messageLimit;)$(this.talksElement).find(".talk:last").remove()}},{key:"_effectGameRoom",value:function(e){var t;this.isGameRoom&&(t=/((第|the)(\s?))(\S{1,2})(((st|nd|rd|th)?)(\s?)(天|day))/i.exec(e))&&DRRRClientBehavior.indicateDate(t[4]),(t=/night|夜|晚|暗/i.exec(e))&&DRRRClientBehavior.indicatePeriod("night"),(t=/白天|早上|morning/i.exec(e))&&DRRRClientBehavior.indicatePeriod("day"),(t=/遊戲結束|游戏结束|結束遊戲|结束游戏|game over/i.exec(e))&&DRRRClientBehavior.indicateDate(!1)}}],[{key:"upgradeMusic",value:function(e){e.direct||(Boolean(e.info)||(e.info={}),e.info.hasOwnProperty("artists")||(e.info.artists=[]),"string"==typeof e.info.artists&&(e.info.artists=[e.info.artists]))}}]),DRRRClient}(),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var DRRRAdminAnnounceClient=function(){function e(){_classCallCheck(this,e);var t=$("#talks");this.renderer=new DRRRClient(t)}return _createClass(e,[{key:"init",value:function(){if(dura&&dura.talks)for(var e in dura.talks){var t=dura.talks[e];for(var n in t)this.renderer.write(t[n])}}}]),e}();if(location.conformTo("/admin_announce")){var client=new DRRRAdminAnnounceClient;client.init()}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var DRRRClientBehavior=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"bindEvents",value:function(t,n){t.on("show.bs.dropdown",".dropdown.music",e.formMusicMenu),t.on("hide.bs.dropdown",".dropdown.music",e.dismissMusicMenu)}},{key:"playMusic",value:function(e,t){Settings.is("mute-music")||box.playMusic(e,t)}},{key:"ringSoundCommon",value:function(){Settings.is("soundeffect")&&(sound.play("bubble"),sound.volume(1))}},{key:"ringSoundSystem",value:function(){Settings.is("soundeffect")&&(sound.play("userin"),sound.volume(1))}},{key:"ringSoundLogout",value:function(){Settings.is("soundeffect")&&(sound.play("userout"),sound.volume(1))}},{key:"checkBubbleTail",value:function(){return!!Settings.is("bubbletail")}},{key:"dismissMusicMenu",value:function(){$(this).find(".dropdown-menu").empty()}},{key:"formMusicMenu",value:function(){var e=$(this).data(),n=$(this).find(".dropdown-menu")[0],i=new DRRRDropdownMenu(n),o=!e.direct&&function(){window.open(e.shareURL,"_blank")};if(i.addNode(e.name,o),e.info.artists)for(var a of e.info.artists)i.addNode(a,!1,"dropdown-item-unclickable");i.addDevisionIfNot(),i.addNode(t(e.source),!1,"dropdown-item-unclickable"),i.resetDevider(),i.addDevisionIfNot();box.playMusic.bind(this,e,{mode:"self"});i.addNode(t("Play this"),!1,"dropdown-item-unclickable"),i.addNode(t("Add this"),box.collectMusic.bind(this,e))}},{key:"newMessageAppended",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._updateScrollPosition(e,t)}},{key:"_updateScrollPosition",value:function(e,t){var n=$(window).scrollTop();if(n>100){var i=e.outerHeight(!0);$(window).scrollTop(n+i)}}},{key:"_bumpCounter",value:function(){updateUnreadCount(),unreadIndicator.show()}},{key:"indicateDate",value:function(e){var n=$("#body > #day-indicator");0===n.length&&(n=$("<div />",{id:"day-indicator",class:"select-none"}).appendTo($("#body"))),e?n.text(t("Day {1}",e)):n.text(""),n.on("tap",function(){$(n).css("opacity","0"),setTimeout(function(){$(n).css("opacity","0.5")},2e4)})}},{key:"indicatePeriod",value:function(e){$(".message_box_effect_wraper");switch(e){case"night":$("body").addClass("game-room--night");break;case"day":default:$("body").removeClass("game-room--night")}}},{key:"literalMusicTitle",value:function(e){return e.direct?e.name:e.name+" - "+e.info.artists.join(", ")}}]),e}(),DRRRDropdownMenu=function(){function e(t){_classCallCheck(this,e),this.menu=t,this.deviderAdded=!1}return _createClass(e,[{key:"addNode",value:function(e,t,n){n=n||"dropdown-item";var i=$("<li />").append($("<a />",{tabindex:"-1",class:n,text:e})).appendTo(this.menu);return t&&i.click(t.bind(this.menu)),i}},{key:"resetDevider",value:function(){this.deviderAdded=!1}},{key:"addDevisionIfNot",value:function(){this.deviderAdded||($("<li />",{class:"divider",role:"presentation"}).appendTo(this.menu),this.deviderAdded=!0)}}]),e}();$(function(){"use strict";var e,t=$("#rooms-placeholder"),n=$("#form-name"),i=$("#form-admin-name"),o=$("#form-language-select"),a=$("#form-user-name"),s=$("#form-room-description"),r=($("#volume"),$(".toggle-members")),l=$(".admin-toggle-pins");if(DRRR.hasLocalStorage){if(Settings.prop("dura-config-migration")&&localStorage["dura-config"]){var c=JSON.parse(localStorage["dura-config"]);for(var u in c)""!==c[u]&&Settings.prop(u,c[u]);Settings.remove("dura-config-migration"),Settings.remove("dura-config")}$(".home-submit-input").click(function(){Settings.prop("username",n.val()),Settings.prop("language",o.val())}),$(".admin-submit-input").click(function(){Settings.prop("admin",i.val()),Settings.prop("language",o.val())}),$(".create-room-submit-input").click(function(){Settings.prop("roomname",a.val()),Settings.prop("roomdescription",s.val())}),$(".toggle-members").click(function(){Settings.prop("members",r.is(":checked")),t.toggleClass("show-members")}),$(".admin-toggle-pins").click(function(){Settings.prop("adminpins",l.is(":checked")),t.toggleClass("admin-show-pins")}),Settings.prop("username")&&n.val(Settings.prop("username")),Settings.prop("admin")&&i.val(Settings.prop("admin")),Settings.prop("language")&&o.val(Settings.prop("language")),Settings.prop("roomname")&&a.val(Settings.prop("roomname")),Settings.prop("roomdescription")&&s.val(Settings.prop("roomdescription")),Settings.is("members")&&(r.prop("checked",!0),t.addClass("show-members")),Settings.is("adminpins")&&(l.prop("checked",!0),t.addClass("admin-show-pins"))}bowser.safari&&document.body.classList.add("device-osx"),bowser.ios&&bowser.version>=9&&document.body.classList.add("device-ios-9"),$(".bstooltip").tooltipster({speed:200,delay:0,interactive:!0,onlyOne:!0,theme:"tooltipster-drrr"}),$(".project-dollars").on("mouseover",function(){var e=$(this);e.hasClass("on")||(e.addClass("on"),window.setTimeout(function(){e.removeClass("on")},1e3))}),$(".zyw").on("click",function(){$(".logo-wrapper").toggleClass("on")}),$("#modal-tripcode-help").on("show.bs.modal",function(e){var t=$(e.relatedTarget),n=t.data("name"),i=t.text(),o=$(this);o.find(".modal-body h4 .name").text(n),o.find(".modal-body h4 .tripcode").text(i)}),e=Settings.prop("language"),$("[data-langs]").each(function(){var t=!1;$(this).attr("data-langs").split(" ").forEach(function(n){n===e&&(t=!0)}),t?$(this).addClass("visible"):$(this).hide()}),function(){var e=Settings.prop("language");$("[data-langs-hide]").each(function(){var t=!1;$(this).attr("data-langs-hide").split(" ").forEach(function(n){n===e&&(t=!0)}),t&&$(this).addClass("hidden")})}()});